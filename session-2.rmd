---
title: 'Freedom to act (Mushin)'
author: 'Ben Whalley, Paul Sharpe, Sonja Heintz'
# date: "April 2021"
bibliography: [references.bib]
biblio-style: apa6
link-citations: yes
output:
  webex::html_clean
---

```{r, include=F, echo=F}
source('_first_chunk.R')
```

# Overview

We think the analogy to using R is clear:

- If you are anxious, stressed or avoidant you will be distracted
- Getting confident with the basics makes more complex techniques possible 

<!-- TODO intro VIDEO -->
`r hide('Video script')`
In this session we cover:

- Loading data from files
- Using simple techniques to answer research questions with data
- Saving intermediate steps using variables

<!-- A literal translation of Mushin is something like 'mind without mind', but in karate and other martial arts the term -->
<!-- denotes the state of mind achieved when free from thoughts of anger, fear, or ego during combat, or in everyday life.  -->

<!-- To achieve mushin takes **repeated practice** and complete familiarity with the technique required to act, such that  -->
<!-- technical details can fade into the background. This leaves the student free to act, responding effortlessly to  -->
<!-- the challenge at hand. -->
`r unhide()`

<!-- - Provide stereotyped examples of the sorts of students positive/negative traits which relate to the theme of session - make it all more concrete -->
<!-- - Provide quotes from previous students illustrating? -->

# Principles/ideas 

- Using data to answer questions
- Precision and literal-mindedness of R
- Paths and directories

# R techniques covered

- [Variables](#variables)
- [The pipe `%>%`](#pipe)
- [The `read_csv` command](#readcsv)
- [The **Files** pane](#filespane)
- [Uploading data files](#upload)
- [The `filter` command](#filter)
- [The `arrange` command](#arrange)
- [The `group_by` command](#groupby)
- [The ``summarise`` command](#summarise)

Activity:

???  set up the teaching as a kind of treasure hunt where students have to find use data to answer questions, gather
clues and spell out a word? Alternatively, just ask them to make *LOTs* of different plots using the techniques above, not
just one:

# Variables {#variables}

In R, a variable is the name of a container which stores data. Variables are created using `<-`, which is called the
**assignment operator**.

<!-- TODO variables VIDEO -->

`r hide('Video script')`
The assignment operator `<-` looks like an arrow that points to the left. This is a reminder that the results of the
calculation on the right hand side will be assigned to the variable on the left hand side. 

The code in this chunk runs the calculation on the right hand side of the assignment operator, `40 + 2`, and assigns the
result to a new variable named `meaningoflife`. The output of the chunk is `42`, the value of `meaningoflife`.

Variables that you create are stored in what's called the `Global Environment`. You can see them in the **Environment**
pane.
`r unhide()`

:::{.exercise}
**Exercise 1**

1. Open `session-2.rmd` using the **Files** pane. This is the workbook you will be using in this session.
1. Run the first chunk in the workbook.

The output should look like this:

![Results of creating `meaningoflife` variable](images/life.png)

Your **Environment** pane should look like this:

![Environment pane after creating `meaningoflife` variable](images/environment1.png)
:::

:::{.exercise}
**Exercise 2**

1. Create a level 3 markdown heading named "Exercise 2" in your workbook
1. Create a new chunk beneath the heading
1. Assign the results of the calculation `26 + 44` to the variable `myfirstvariable`
1. Run the chunk

Your **Environment** should now look like this:

![Environment pane after creating `myfirstvariable`](images/environment2.png)
:::

# The pipe {#pipe}

The pipe command `%>%` sends data from one piece of code to another.

<!-- TODO pipe VIDEO -->

`r hide('Video script')`
The pipe command `%>%` sends data from one piece of code to another. In session 1, you used the command [`mtcars %>%
head()`] to "pipe" the `mtcars` dataset into `head`, which shows just the first few rows.

You can think of your data as flowing along lengths of pipe, joined by commands which transform the data, step by step,
until it plops out the end in the format you want. Each command should be read as 'then', e.g. "pipe `mtcars` data,
*then* `head` it". The `>` in the pipe command reminds you of the direction in which your data is flowing.

You will frequently want to store the results of a pipeline in a variable. For example, the command [`mtcars_head <-
mtcars %>% head()`], assigns the result of the pipeline (a data.frame containing the first few rows of `mtcars`) to a
new variable called `mtcars_head`.

You can [explore your variables using the **Environment** pane]. A data.frame will have an icon that looks like a
spreadsheet. If you [click on the icon], the data.frame is displayed in a new tab in the **Source** pane.

This tab shows you the same information as printing the data.frame, such as the number of rows and columns, but it
also provides tools for exploring the data interactively.

* The arrows next to the column names allow you to arrange the rows in ascending or descending order based on the column
values.
* The `Filter` button allows you to specify a value for one or more columns to filter out non-matching rows. For
example, we could display just cars with 4 gears. Click the button again to turn off the filter.
`r unhide()`

:::{.exercise}
**Exercise 3**

1. Create a level 3 markdown heading named "Exercise 3" in your workbook. (You should be used to doing this for every exercise by now, so we won't remind you again.)
1. Create a new chunk beneath the heading
1. Load the `tidyverse` library
1. Pipe the `mpg` data.frame into `head()` and assign the results to a variable called `mpg_head`
1. Use the **Environment** pane to open `mpg_head`

In 1999, a 6 cylinder, manual transmission, Audio A4 could cover `r fitb('18')` miles per gallon when driven in the
city.
:::

# The `read_csv` command {#readcsv}

The preferred format for data files in R is comma-separated value (CSV). Data in CSV format can be read using the
`read_csv` command.

<!-- TODO read_csv VIDEO -->

`r hide('Video script')`
The file [https://raw.githubusercontent.com/benwhalley/lifesavR/main/lifesavr/shootings.csv] is a CSV file containing
data about US police shootings. The first line is a list of column names separated by columns. Each of the remaining
lines contain rows of data, matching the column headings. For example, the value of the `arms_category` column in row
1 is `Guns`.

The `read_csv()` command reads a CSV file, and converts it to a data.frame. The first line is used as the column names,
and the remain lines are converted to rows. A CSV file can be read directly from the Internet and stored in a variable.
The URL (the link to the CSV file) needs to be in quotes (single or double quotes both work).
`r unhide()`

The following chunk reads the US police shootings CSV file from the Internet, and stores the resulting data.frame in the
variable `shootings`.

```{r}
shootings <- read_csv('https://raw.githubusercontent.com/benwhalley/lifesavR/main/lifesavr/shootings.csv')
```

The [British School Success Survey](https://www.kaggle.com/brsdincer/schooldata/) is a dataset used to predict school performance. 

:::{.exercise}
**Exercise 4**

1. Copy the chunk above into your workbook
1. Change `shootings.csv` to `schoolpredict.csv`
1. Read the data into the variable `school_predict`
1. Open `school_predict` in the **Source** window

The school with the most teaching assistants has `r fitb('141')` teachers.
:::

# The **Files** pane {#filespane}

- loading a datafile from the same directory as the rmd file (created by bootstrap script)

# Uploading data files {#upload}

- uploading a datafile from your own computer `read_csv` it
- importance of file extensions

# Filter

- Introduce operators `< > =`

```{r}
gapminder::gapminder %>% filter(country=="Kenya")
```

Combined filters

```{r}
gapminder::gapminder %>% 
  filter(country=="Kenya") %>% 
  filter(year > 2000)
```

# Arrange

remind them they know how to make scatter and boxplots
 
- "what is the size of the largest diamond (by carat) in the `diamonds` dataset? 
- "what cut were the three largest diamonds in that dataset?"

```{r}
diamonds %>% arrange(-carat) %>% head(3)
```

# Filter and arrange

What was the year Kenyans had the lowest life exp:

```{r}
gapminder::gapminder %>% filter(country=="Kenya") %>% 
  arrange(lifeExp) %>% 
  head(6)
```


What was the highest year? All that changes is the minus sign (reverse sorting)

```{r}
gapminder::gapminder %>% 
  filter(country=="Kenya") %>% 
  arrange(-lifeExp) 

```

# `summarise`

TODO make sure to emphasise giving the summary a name (`average_mpg`)

- This is where we fist encounter the need to give things R-legal names so explan about spaces and special characters
- Emphasise everything should be lower case with underscores

```{r}
mtcars %>% summarise(average_mpg = mean(mpg))
```

## `filter and summarise` together

```{r}
mtcars %>% filter(am==1) %>% summarise(mean(mpg))
```

## `group_by` (with `summarise`)

We might make a plot like this:

```{r}
mtcars %>% 
  ggplot(aes(factor(cyl), mpg)) + 
  geom_boxplot()
```

What if we want these numbers in a table (or to report in our report)?

```{r}
mtcars %>% 
  group_by(cyl) %>% 
  summarise(average_mpg = mean(mpg))
```

We can group by two variables at once and get a row for each combination:

```{r}
mtcars %>% group_by(cyl, am) %>% summarise(mean(mpg))
```



# Dividing up graphs

In our previous plot we only showed the difference between cars of 4, 6 and 8 cylinders. We can break the plot down
into multiple panels using '**facets**':


```{r}
mtcars %>% 
  ggplot(aes(factor(cyl), mpg)) + 
  geom_boxplot() + 
  facet_wrap(vars(am))   # note to paul... use vars here to avoid quoting of variable names which is confusing/inconsistent with other use
```

# Check your knowledge

Write an answer to each of these questions in the `Check your knowledge` section of your workbook. The answers will be
revealed in Session 3.

- What is the `%>%` symbol called and what does it do?
- What is the `<-` symbol called and what does it do?

# Practice problems

Additional questions

- what country had the highest life expectancy in  1952?


```{r}
gapminder::gapminder %>% filter(year == 1952) %>% 
  arrange(-lifeExp) %>% 
  head(1)
```

- what continent had the highest GDP in 2011?

```{r}
gapminder::gapminder %>% 
  group_by(continent) %>% 
  summarise(average_gdp = mean(gdpPercap)) %>% 
  arrange(-average_gdp)
```



- make a boxplot showing life expectancy by continent

```{r}
gapminder::gapminder %>% 
  filter(year > 2000) %>% 
  ggplot(aes(continent, lifeExp)) + 
  geom_boxplot()

```



# "Mega problem"


Describe these as the 'end of level boss characters'. You need to combine all your skills to beat them...


Make a table which shows the average life expectancy for each continent, sorted from highest to lowest:


```{r}
gapminder::gapminder %>% 
  group_by(continent) %>% 
  summarise(life_expectancy = mean(lifeExp)) %>% 
  arrange(-life_expectancy)
```




# Broken script to fix

- Fix a 'broken' script: Start a NEW R session and make this code work:
 

```{r, eval=F}
liibrary(todyverse)

# make a density plot of of life expectacy with different color lines for each continent
gapminder::gapminder %>% 
  ggplote(aes("lifeExp", colr = "Continent"))  geom_density()

# select only years after 1990
gapminder::gapminder %>% 
  filter(year > 1990)

ggplot(aes(year, lifeExp, color=continent)) + 
  geom_jitter()
  
```


NOTE - we will know all the errors they will see so can provide hints for each of them


Correct version would be: 

```{r}
library(tidyverse)

# make a density plot of of life expectacy with different color lines for each continent
gapminder::gapminder %>% 
  ggplot(aes(lifeExp, color = continent))  + 
  geom_density()

# select only years after 1990
gapminder::gapminder %>% 
  filter(year > 1990) %>%
  ggplot(aes(year, lifeExp, color=continent)) + 
  geom_jitter()
```





